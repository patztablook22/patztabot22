#!/usr/bin/bash

#PBS -N discord_bot
#PBS -j oe

DATADIR=/storage/brno2/home/zavorap/
PROJECT=$DATADIR/rp-patrik-zavoral
SCRATCH_PROJECT=$SCRATCHDIR/rp-patrik-zavoral
SCRATCH_VENV=$SCRATCH_PROJECT/venv

export TMPDIR=$SCRATCHDIR

# add modules

module add \
    python/python-3.10.4-gcc-8.3.0-ovkjwzd \
    cuda/cuda-11.2.0-intel-19.0.4-tn4edsz \
    cudnn/cudnn-8.1.0.77-11.2-linux-x64-intel-19.0.4-wx22b5t

if [ ! -d $SCRATCH_VENV ]; then
    mkdir -p $SCRATCH_VENV
    python3.10 -m venv $SCRATCH_VENV
    source $SCRATCH_VENV/bin/activate

    pip3 install \
        'git+https://github.com/patztablook22/genbot' \
        torch \
        accelerate \
        transformers \
        #'tensorflow~=2.11.0' \
        ||
        (echo "Installing dependencies failed." >&2 && exit 1)
else
    source $SCRATCH_VENV/bin/activate
fi

$PROJECT/bin/patztabot

#rm -rf $SCRATCHDIR/*

